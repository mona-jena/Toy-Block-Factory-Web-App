---
steps:
  - label: ':cherry_blossom::whale: run tests'
    command: 'docker build -f ./Dockerfile.test .' 
    agents:
      queue: grace-lab
  - wait
  - label: 'run ecr'
    command: 'aws cloudformation deploy --template-file ecr.yml --stack-name mona-ecr' #FIX
    agents:
      queue: grace-lab
  - wait 
  - label: ':ec2: make dockerimage with tbf' #builds docker image thats in this ecr and run these commands on an ec2 instance
    command:
      - 'docker build -t 138666658526.dkr.ecr.ap-southeast-2.amazonaws.com/mona-app:${BUILDKITE_BUILD_NUMBER} .' 
      - 'docker push 138666658526.dkr.ecr.ap-southeast-2.amazonaws.com/mona-app:${BUILDKITE_BUILD_NUMBER}' #pushing latest image to ecr
    plugins:
      - ecr#v2.3.0:
          login: true
          account_ids: "138666658526"
          region: "ap-southeast-2"
    agents:
      queue: grace-lab 
  - wait
  - label: ':k8s: deploy on jupiter'
    command: './bin/deploy.sh ${BUILDKITE_BUILD_NUMBER}'
    agents:
      queue: europa-preprod-fma
